networks:
  auth-example:

volumes:
  pg_data:
  static:
  media:

services:

  nginx-auth-example:
    container_name: nginx-auth-example
    image: nginx:stable-alpine

    volumes:
      # Официальный образ nginx делает envsubst для /etc/nginx/templates/*.template
      - ./conf/nginx.conf.template:/etc/nginx/templates/default.conf.template:ro
      - static:/app/static_backend/:ro
      - media:/media/:ro

    ports:
      - ${NGINX_HOST_PORT:-8080}:80

    environment:
      - NGINX_SERVER_NAME=${NGINX_SERVER_NAME:-localhost}
      - BACKEND_URL=${BACKEND_URL:-http://backend:8006}
      - NGINX_PROXY_CONNECT_TIMEOUT=${NGINX_PROXY_CONNECT_TIMEOUT:-70s}
      - NGINX_PROXY_SEND_TIMEOUT=${NGINX_PROXY_SEND_TIMEOUT:-86400}
      - NGINX_PROXY_READ_TIMEOUT=${NGINX_PROXY_READ_TIMEOUT:-86400}
      - NGINX_SEND_TIMEOUT=${NGINX_SEND_TIMEOUT:-86400}
      - NGINX_CLIENT_MAX_BODY_SIZE=${NGINX_CLIENT_MAX_BODY_SIZE:-100M}

    depends_on:
      - backend

    networks:
      - auth-example

  db:
    image: postgres:13.10
    env_file: .env
    volumes:
      - pg_data:/var/lib/postgresql/data
    ports:
      - 5432
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U $$POSTGRES_USER -d $$POSTGRES_DB" ]
      interval: 10s
      timeout: 5s
      retries: 3
    networks:
      - auth-example

  backend:
    build:
      context: ./backend/
      dockerfile: ./Dockerfile
    env_file: .env
    command: bash -c "python manage.py migrate && python manage.py collectstatic --no-input; while true; do echo 'I am alive!'; sleep 3600; done"
    volumes:
      - static:/app/static_backend/
      - media:/media/

    depends_on:
      db:
        condition: service_healthy

    networks:
      - auth-example
  